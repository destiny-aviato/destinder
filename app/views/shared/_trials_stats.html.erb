<% info = get_stats("too") %>
<% username = @user.nil? ? @player_stat.display_name : @user.display_name %>
<% character_races = {0 => "Titan", 1 => "Hunter", 2 => "Warlock"} %>
<% weapons = {"Auto Rifle" => "auto3.png", 
        "Pulse Rifle" => "pulse2.png", 
        "Hand Cannon" => "handcannon2.png",
        "Sniper Rifle" => "sniper2.png",
        "Shotgun" => "shotgun2.png",
        "Scout Rifle" => "scout.png",
        "Fusion Rifle" =>  "fusion2.png",
        "Sidearm" => "sidearm.png",
        "Rocket Launcher" => "heavy2.png"
        } %>
<br><br>
<% if info.nil? %> 
    <%= render 'shared/no_data' %>
<% else %>  
    <a id="expand-button" class="waves-effect waves-light btn" onClick="expandAll();"><i class="material-icons left">fullscreen</i>Open All</a>
    <a id="collapse-button" class="waves-effect waves-light btn" onClick="collapseAll();"><i class="material-icons left">fullscreen_exit</i>Close All</a>
    <hr>
<div class="row player-stats-collapse" style="margin-left: -8%; margin-right: -8%">    
        <div class="col s12" >
            <div id="stat-graphs"> 
                <ul id="test-collapse" class="collapsible popout" data-collapsible="expandable">
                    <% info.each_with_index do |character, index| %>
                        <div class="tooltip_templates">                                                      
                            <span id="diamond_elo_content">
                                <div class="row center-align">
                                    Diamond Tier
                                </div>
                                <div class="row center-align">
                                    # <%= character['Character Stats']['ELO']['Rank'] %>
                                </div>
                            </span>
                            <span id="platinum_elo_content">
                                <div class="row center-align">
                                    Platinum Tier
                                </div>
                                <div class="row center-align">
                                    # <%= character['Character Stats']['ELO']['Rank'] %>
                                </div>
                            </span>
                            <span id="gold_elo_content">
                                <div class="row center-align">
                                    Gold Tier
                                </div>
                                <div class="row center-align">
                                    # <%= character['Character Stats']['ELO']['Rank'] %>
                                </div>
                            </span>
                            <span id="silver_elo_content">
                                <div class="row center-align">
                                    Silver Tier
                                </div>
                                <div class="row center-align">
                                    # <%= character['Character Stats']['ELO']['Rank'] %>
                                </div>
                            </span>
                            <span id="bronze_elo_content">
                                <div class="row center-align">
                                    Bronze Tier
                                </div>
                                <div class="row center-align">
                                    # <%= character['Character Stats']['ELO']['Rank'] %>
                                </div>
                            </span>
                        </div>
                        <li>
                            <% x = character %>
                            <% case x["Character Items"]["Subclass"]["Item Name"] 
                                when "Nightstalker", "Voidwalker", "Defender" %>
                                <% subclass =  "height: 20px; position: relative; bottom: 20px; background-image: url(#{image_path "void.png"}); background-size: cover;background-position-y: -50px;" %>
                                <% text_color =  "color: #f5f5f5; font-size: 14px; text-shadow: none;" %>
                            <% when "Sunsinger", "Gunslinger", "Sunbreaker" %>
                                <% subclass =  "height: 20px; position: relative; bottom: 20px;background-image: url(#{image_path "solar.png"}); background-size: cover;background-position-y: -50px;" %>
                                <% text_color =  "color: #3a3a3a; font-size: 14px;" %>
                            <%  when "Bladedancer", "Striker", "Stormcaller" %>
                                <% subclass =  "height: 20px; position: relative; bottom: 20px; background-image: url(#{image_path "arc.png"}); background-size: cover;background-position-y: -50px;" %>
                                <% text_color =  "color: #3a3a3a; font-size: 14px;" %>
                            <% end %>
                            <div class="collapsible-header" id="collapse-header" style="height: 104px; padding: 0;">
                                <div class="row" style="margin-right: 0; margin-left: 0; width: 100%;">
                                    <div class="col s12 m4">
                                        <% bg = "background-image: url(#{x['Character Items']['Emblem Background']});" %>
                                        <div class="post-header" style='<%= "#{bg} margin: -3.3%; height: 83px; margin-top: 0;" %>'>                            
                                            <div class="row" style="overflow: hidden; max-height: 65px; margin-right: 0;">
                                                <div class="col s3 left-align" style="padding: 0; height: 65px;">
                                                    <%= image_tag x["Character Items"]["Emblem"]["Item Icon"], style:"max-width: calc(100% - 2.6em); min-width: 65px; position: relative; right: 3%; height: auto;" %>
                                                </div>
                                                <div class="col s6 center-align" style="height: 65px; color: white;"><span style="font-size: 1.5em; text-overflow: ellipsis; color: #f5f5f5; position: relative; top: 25%; font-weight: 400;" ><%= username %></span></div>
                                                <div class="col s3 center-align" style="height: 65px; color: white;">
                                                    <span style="color: gold; position: relative; top: 10%; line-height: 2.4em; font-weight: 300; font-size: 1.3em;">âœ¦ <%= x["Character Stats"]["Light Level"] %> </span>
                                                    <span style="font-weight: 300; font-size: 1.1em;"><%= character_races[x["Character Type"]] %></span>
                                                </div>
                                            </div>
                                            <div class="post-subheader" style="position: relative;height: 18px;bottom: 20px;">
                                                <div>
                                                    <div class="row hide-on-med-and-up">
                                                        <div class="col s4 center-align" style="white-space: nowrap;">
                                                            <% if x["Character Stats"]["ELO"]["ELO"].to_i >= 1700 %>
                                                                <% elo = "<span class='tooltip' data-tooltip-content='#diamond_elo_content' style='color:#7198B7;'> <b>#{x['Character Stats']['ELO']['ELO']}</b></span> " %>
                                                            <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1700 && x["Character Stats"]["ELO"]["ELO"].to_i >= 1500 %>
                                                                <% elo = "<span class='tooltip' data-tooltip-content='#platinum_elo_content' style='color:#58907E;'> <b>#{x['Character Stats']['ELO']['ELO']}</b></span> " %>
                                                            <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1500 && x["Character Stats"]["ELO"]["ELO"].to_i >= 1300 %>
                                                                <% elo = "<span class='tooltip' data-tooltip-content='#gold_elo_content' style='color:#CCAE50;'> <b>#{x['Character Stats']['ELO']['ELO']}</b></span> " %>
                                                            <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1300 && x["Character Stats"]["ELO"]["ELO"].to_i >= 1200 %>
                                                                <% elo = "<span class='tooltip' data-tooltip-content='#silver_elo_content'  style='color:#BFC4C2;'> <b>#{x['Character Stats']['ELO']['ELO']}</b></span> " %>
                                                            <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1200 %>
                                                                <% elo = "<span class='tooltip' data-tooltip-content='#bronze_elo_content' style='color:#AA885F;'> <b>#{x['Character Stats']['ELO']['ELO']}</b></span> " %>
                                                            <% end %>  
                                                            <span class="white-text" style="font-size: 13px; vertical-align: text-top;">ELO: <%= elo.html_safe %></span>
                                                        </div>
                                                        <div class="col s4 center-align" style="white-space: nowrap;">
                                                            <span class="white-text" style="font-size: 13px; vertical-align: text-top;">KD: <%= x["Character Stats"]["K/D Ratio"] %></span>
                                                        </div>
                                                        <div class="col s4 center-align" style="white-space: nowrap;">
                                                            <span class="white-text" style="font-size: 13px; vertical-align: text-top;">W/L: <%= x["Character Stats"]["Win Rate"] %>%</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="post-subclass-header" style='<%= subclass %> center-align' >
                                                <div class="row">
                                                    <div class="col s12 m4"></div>
                                                    <div class="col s12 m4 center-align">
                                                        <span class="" style="color: white;"> <%= x["Character Items"]["Subclass"]["Item Name"]  %></span>                                                                                                                                    
                                                    </div>
                                                    <div class="col s12 m4"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col s12 m6 center-align hide-on-small-only" style="height: 103px;">
                                        <div class="row center-align" style="margin-top: 1.9%; margin-bottom: 0;"><!--OPEN GUN PICTURES ROW-->                                                                          
                                            <div class="col s3 weapon-container center-align">
                                                <img class="gun-icons-trials tooltipped" data-position="right" data-delay="50" data-tooltip="<%= x["Character Items"]["Primary Weapon"]["Item Name"] %>" src=<%= x["Character Items"]["Primary Weapon"]["Item Icon"] %> alt=""><br>
                                                <span class="truncate" style="font-size: 0.8em;"><%= x["Character Items"]["Primary Weapon"]["Item Name"] %></span> 
                                            </div>
                                            <div class="col s3 weapon-container center-align">
                                                <img class="gun-icons-trials tooltipped" data-position="right" data-delay="50" data-tooltip="<%= x["Character Items"]["Secondary Weapon"]["Item Name"] %>" src=<%= x["Character Items"]["Secondary Weapon"]["Item Icon"] %> alt=""><br>
                                                <span class="truncate" style="font-size: 0.8em;"><%= x["Character Items"]["Secondary Weapon"]["Item Name"] %></span> 
                                            </div>
                                            <div class="col s3 weapon-container center-align">
                                                <img class="gun-icons-trials tooltipped" data-position="right" data-delay="50" data-tooltip="<%= x["Character Items"]["Heavy Weapon"]["Item Name"] %>" src=<%= x["Character Items"]["Heavy Weapon"]["Item Icon"] %> alt=""><br>
                                                <span class="truncate" style="font-size: 0.8em;"><%= x["Character Items"]["Heavy Weapon"]["Item Name"] %></span> 
                                            </div>
                                            <% x["Character Items"].each do |item| %>
                                                <% next if ["Emblem Background", "Emblem"].include?(item[0])  %>
                                                <% if item[1]["Item Tier"] == "Exotic" %>
                                                    <% if ["Chest Armor", "Gauntlets", "Helmet", "Leg Armor"].include? (item[0])  %>
                                                        <div class="col s2 weapon-container center-align">
                                                            <img class="gun-icons-trials tooltipped" data-position="right" data-delay="50" data-tooltip="<%= item[1]["Item Name"] %>" src=<%= item[1]["Item Icon"] %> alt=""><br>
                                                            <span class="truncate" style="font-size: 0.8em;"><%= item[1]["Item Name"] %></span> 
                                                        </div>
                                                        <% break %>                                                                                                                     
                                                    <% end %>
                                                <% end %>
                                                <!-- <div class="col s2 weapon-container center-align"><img class="gun-icons-trials tooltipped" data-position="right" data-delay="50" data-tooltip="<%= x["Character Items"]["Helmet"]["Item Name"] %>" src=<%= x["Character Items"]["Helmet"]["Item Icon"] %> alt=""></div> -->
                                            <% end %>
                                            <!-- <div class="col s3">PRIMARY</div>
                                            <div class="col s3">SECONDARY</div>
                                            <div class="col s3">HEAVY</div>
                                            <div class="col s3">HELMET</div> -->
                                        </div><!--CLOSE GUN PICTURES ROW-->
                                    </div>
                                    <div class="col s12 m2 center-align hide-on-small-only" style='<%= "#{bg} height: 104px; color: #f5f5f5;border-bottom: 1px gray solid; padding-top: 1.5%; background-repeat: no-repeat; background-size: cover; background-position-x: 17%;" %>'>
                                        <div class="col s12 m6 right-align hide-on-small-only" style="width: 65%">
                                                <% if x["Character Stats"]["ELO"]["ELO"].to_i >= 1700 %>
                                                    <% elo = "<span class='tooltip' data-tooltip-content='#diamond_elo_content' style='color:#7198B7;'><b>#{x['Character Stats']['ELO']['ELO']}</b></span>" %>
                                                <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1700 && x["Character Stats"]["ELO"]["ELO"].to_i >= 1500 %>
                                                    <% elo = "<span class='tooltip' data-tooltip-content='#platinum_elo_content' style='color:#58907E;'><b>#{x['Character Stats']['ELO']['ELO']}</b></span>" %>
                                                <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1500 && x["Character Stats"]["ELO"]["ELO"].to_i >= 1300 %>
                                                    <% elo = "<span class='tooltip' data-tooltip-content='#gold_elo_content' style='color:#CCAE50;'><b>#{x['Character Stats']['ELO']['ELO']}</b></span>" %>
                                                <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1300 && x["Character Stats"]["ELO"]["ELO"].to_i >= 1200 %>
                                                    <% elo = "<span class='tooltip' data-tooltip-content='#silver_elo_content'  style='color:#BFC4C2;'><b>#{x['Character Stats']['ELO']['ELO']}</b></span>" %>
                                                <% elsif x["Character Stats"]["ELO"]["ELO"].to_i < 1200 %>
                                                    <% elo = "<span class='tooltip' data-tooltip-content='#bronze_elo_content' style='color:#AA885F;'><b>#{x['Character Stats']['ELO']['ELO']}</b></span>" %>
                                                <% end %> 
    
                                                <span  style="font-size: 16px;"><%= elo.html_safe %> ELO</span><br>
                                                <span  style="font-size: 18px;"><b><%= x["Character Stats"]["K/D Ratio"] %> </b>K/D</span><br>                                                                                                   
                                        </div>
                                        <div class="col s12 m6 right-align hide-on-small-only" style="width: 35%;">
                                            <span ><i id='<%= "collapse-icon-#{index}" %>'class="material-icons left more" style="color: #f5f5f5; font-size: 48px;">keyboard_arrow_down</i></span> 
                                            <span ><i id='<%= "collapse-icon-#{index}" %>'class="material-icons left less" style="color: #f5f5f5; font-size: 48px; display: none">keyboard_arrow_up</i></span>                                                            
                                        </div>
                                    </div>                                
                                </div>
                            </div>            
                            <div class="collapsible-body" style="background: #fff;">
                                    <% if x['Character Stats']['Kill Stats'] == 0 %> 
                                        Sorry, no data found for this character. 
                                    <% else %>
                                        <div class="row">                                
                                            <div class="col s12 m3 center-align">                                            
                                                <div class='<%="chart-container#{index + 1}" %>' data-chart-data="<%= character.to_json %>"></div>
                                                <div><canvas id='<%= "weapon-breakdown-chart#{index + 1}" %>' style="max-width: 275px !important; max-height: 275px !important"></canvas></div>                    
                                            </div>
                                            <hr class="hide-on-med-and-up">
                                            <div class="col s12 m6 center-align">                                                                        
                                                <div><canvas id='<%= "kill-chart-breakdown#{index + 1}" %>'></canvas></div>                    
                                            </div>
                                            <hr class="hide-on-med-and-up">
                                            <div class="col s12 m3 center-align" >             
                                                    <div class="col s6" style="margin-top: 2%;">
                                                        <div style="margin-bottom: -30%;"><canvas id='<%= "ability-chart-breakdown#{index + 1}" %>' style="max-width: 150px !important; max-height: 150px !important"></canvas></div> 
                                                        <br><p class="stat-heading"><%= "#{x["Character Stats"]["Win Rate"]}%" %></p>       
                                                    </div>                                        
                                                    <div class="col s6" style="margin-top: 2%;">
                                                        <div style="margin-bottom: -30%;"><canvas id='<%= "revive-chart-breakdown#{index + 1}" %>' style="max-width: 150px !important; max-height: 150px !important"></canvas></div>        
                                                        <% total = x["Character Stats"]["Kill Stats"]["Revives Performed"].to_i + x["Character Stats"]["Kill Stats"]["Revives Received"].to_i %>
                                                        
                                                        <% res_percent =  total.to_i != 0  ? ((x['Character Stats']['Kill Stats']['Revives Performed'].to_i / total.to_i) * 100.0) : 0 %>                                                        
                                                        <br><p class="stat-heading"><%= "#{res_percent}%" %></p> 
                                                    </div>                                        
                                                    <div class="col s12">
                                                        <!-- <table class="centered responsive-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Best Weapon</th>
                                                                    <th>Longest Spree</th>
                                                                    <th>Avg. Kill Distance</th>
                                                                </tr>
                                                            </thead>
                                                    
                                                            <tbody>
                                                                <tr>
                                                                    <td><%= image_tag "primary-weapon.png", style: "height: 16px;"  %></td>
                                                                    <td style="font-size: 1.0em; font-weight: 600;">9</td>
                                                                    <td style="font-size: 1.0em; font-weight: 600;">17.6</td>
                                                                </tr>                                                        
                                                            </tbody>
                                                        </table>     -->
                                                        <p class="stat-heading">PLAYER ANALYSIS</p>
                                                        <div class="col s6" style="color:red;">badge</div>
                                                        <div class="col s6" style="color:red;">badge</div>
                                                        <div class="col s6" style="color:red;">badge</div>
                                                        <div class="col s6" style="color:red;">badge</div>
                                                    </div>                                        
                                            </div>                                    
                                        </div>
                                        <hr>
                                        <div class="row" style="padding-top: 1%;margin-bottom: 0%;">
                                            <div class="col s6 m2 center-align">
                                                <p class="stat-heading">KA/D Ratio</p>
                                                <p class="stat-title"><%=x["Character Stats"]["KA/D Ratio"] %></p>
                                            </div>
                                            <div class="col s6 m2 center-align">
                                                <p class="stat-heading">Games Played</p>
                                                <p class="stat-title"><%= (x["Character Stats"]["games_won"] + x["Character Stats"]["games_lost"]).round %></p>
                                            </div>
                                            <div class="col s12 m4 center-align">
                                                <p class="stat-heading">Best Weapon</p>
                                                <% if (!x["Character Stats"]["Kill Stats"]["Best Weapon Type"].nil? &&  x["Character Stats"]["Kill Stats"]["Best Weapon Type"] != 0) %>
                                                    <p class="stat-title tooltipped" data-position="bottom" data-delay="50" data-tooltip='<%= x["Character Stats"]["Kill Stats"]["Best Weapon Type"] %>'><%= image_tag weapons[x["Character Stats"]["Kill Stats"]["Best Weapon Type"]], style: "height: 35px;"  %></p>
                                                <% else %>
                                                    <p class="stat-title tooltipped" data-position="bottom" data-delay="50" data-tooltip='Rocket Launcher...Yikes.'><%= image_tag weapons["Rocket Launcher"], style: "height: 35px;" %></p>
                                                <% end %>
                                            </div>
                                            <div class="col s6 m2 center-align">
                                                <p class="stat-heading">Longest Spree</p>
                                                <p class="stat-title"><%=x["Character Stats"]["Kill Stats"]["Longest Spree"].round %></p>
                                            </div>
                                            <div class="col s6 m2 center-align">
                                                <p class="stat-heading">Avg. Kill Distance</p>
                                                <p class="stat-title"><%=x["Character Stats"]["Kill Stats"]["Average Kill Distance"] %></p>
                                            </div>  
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col s12">
                                                <h5>Account Badges</h5>
                                                <% if !@user.nil? %>
                                                    <% @user.badges.each do |badge| %>                
                                                        <div class="chip tooltipped" style='<%= badge.custom_fields[:color] %>'data-position="top" data-delay="50" data-tooltip="<%= badge.description %>">
                                                            <%= badge.name %>
                                                            <%= badge.custom_fields[:icon].html_safe %>
                                                        </div>                
                                                    <% end %>
                                                <% end %>
                                            </div>
                                        </div>
                                    <% end %>
                            </div>
                        </li>            
                    <% end %>
                </ul>
            </div>
        </div>

    
    </div>

<% end %>

